<html>
<head>
<title></title>
<meta charset="utf-8" />
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
</head>
<body>

<script>
"use strict";

var DELETE = 0;
var INSERT = 1;
var SKIP = 2;

var myid = 0;

var pointers = [];
var buffer = [];
var lastindex = 0;
var _time = 0;
var commandQueue = new CommandQueue();
pointers[myid] = 0;



function skip(distance){

        
}

function adjustPointers(distance, index){

        for (var i = 0; i<pointers.length; i++){

                if (pointers[i] >= index){
                        //console.log("Shift pointer %d", distance);
                        pointers[i] += distance;
                }
        }
}

function insert(number, index){

        //console.log("insert index : " + index);
        rightShift(index);
        buffer[index]=number;
        lastindex++;
        

}

function remove(index){

        //console.log("removing at index %d..", index);
        var removed = buffer[index];
        leftShift(index);
        buffer[lastindex] = null;
        lastindex--;
        return removed;
        
}

function skip(id, direction){

        pointers[id] += direction;

}

//AAAAAAAAAB
function rightShift(index){

        for(var i = lastindex; i> index; i--){

                buffer[i] = buffer[i-1];

        }

}

function leftShift(index){

        for(var i = index+1; i< lastindex; i++){

                buffer[i-1] = buffer[i];

        }

}

function execute(command){

        var index = pointers[command[1]];

        switch (command[0]){

        case INSERT:
                insert(command[3], index);
                adjustPointers(1, index);
                break;

        case DELETE:
                printBuffer();
                adjustPointers(-1, index);
                index = pointers[command[1]];
                command[3] = remove(index);
                //console.log("-----------delete %d at %d", command[3], index);
                break;        
        case SKIP:
                skip(command[1], command[3]);
                break;

        }
}

function rewind(command){
        //console.log("rewind");
        var index = pointers[command[1]];

        switch (command[0]){

        case INSERT:
                adjustPointers(-1, index);
                index = pointers[command[1]];
                remove(index);
                break;

        case DELETE:
                printBuffer();
                
                index = pointers[command[1]];
                //console.log("--------------undo delete %d at %d", command[3], index);
                
                insert(command[3], index);
                adjustPointers(1, index);
                break;

        case SKIP:
                skip(command[1], -command[3]);
                break;
        }

        
}

function insertIntoQueue(command){

        var node = commandQueue.peek();

        if (node===null||command[2]>node.command[2]){

                if (node===null){

                }
                else{
                //console.log("push to head cause %d is greater than %d", command[2], node.command[2]);
                }
                commandQueue.push(command);
                execute(command);
                return 0;
        }

        rewind(node.command);
        //console.log("%d is less than %d", command[2], node.next.command[2]);
        while (node.next !==null && command[2]<node.next.command[2]){
        //console.log("yes");
                
                node = node.next;
                rewind(node.command);
                //console.log("%d is less than %d", command[2], node.next.command[2]);
        }

        commandQueue.insertAfter(node, command);
        execute(command);

        while(node!==null){

                execute(node.command);
                node = node.prev;

        }

}

function printBuffer(){
        var str = '[';


        for (var i = 0; i<lastindex; i++){
                str+=String.fromCharCode(buffer[i]);
                //str+=(buffer[i]);
                str+=', ';
        }

        str+= '] , cursor : ' + pointers[myid];

        console.log(str);
}

function printQueue(){
        var str = '[';
        var head = commandQueue.peek();
        while(head){
                str+=head.command[3]
                str+=', ';
                head=head.next;
        }

        str+= ']';

        console.log(str);
}


function runtest(){
        //type, id, time, number
        
        processKey(113, 0); //q
        processKey(119, 1); //w
        processKey(101, 2); //e
        processKey(114, 3); //r
        processKey(116, 4); //t

//qssssyuiowert
        processKey(121, 13);
        processKey(117, 14);
        processKey(105, 15);
        processKey(111, 16);

        processKey(37, 5);
        processKey(37, 6);
        processKey(37, 7);
        processKey(37, 8);

        processKey(115, 9);
        processKey(115, 10);
        processKey(115, 11);
        processKey(115, 12);

        _time = 17;
        printBuffer();

        console.log("[q, s, s, s, s, y, u, i, o, w, e, r, t, ]");



        //37 39 left right
        //46 delete
    

}

function Node(command){

        this.next=null;
        this.prev=null;
        this.command=command;
}

function CommandQueue(){

       
        var head = null;

        var _insertAfter = function(node, newnode){

             

                if (node.next !== null){

                        node.next.prev = newnode;

                }

                newnode.next = node.next;
                
                newnode.prev = node;
                node.next = newnode;

              
                //node = newnode;

        };



        this.push = function(command){

                var temp = new Node(command);

                if (head===null){

                        head = temp;
                        //temp.prev = null;
                        //temp.next=null;

                }
                else{
                       
                       temp.next = head;
                       head.prev = temp;
                       head = temp;

                }

                

        };

        this.insertAfter = function(node, command){

               var temp = new Node(command);

               _insertAfter(node, temp);


        };

        this.peek = function(){

                return head;
        };


}

runtest();

function sendCommand(t){

        //not
}

function processKey(e, time){

        time = time || _time;

        switch (e){

        case 13://enter
                sendCommand(13);
                break;
        case 46://delete       
        case 8://backspace   
                insertIntoQueue([DELETE, myid, time, -1]);
                break;
        case 9: //tab 
                sendCommand(9);
                break;
        case 37:
                insertIntoQueue([SKIP, myid, time, -1]);
                break;
        case 39:
                insertIntoQueue([SKIP, myid, time, 1]);
                break;
                /*
        case 53:
                insertIntoQueue([INSERT, myid, 50, e]);
                break;
                */
        default:
                insertIntoQueue([INSERT, myid, time, e]);

        }

        
        //console.log("command %d", e);
}

$(document).on("keypress", function (e){

        e.preventDefault();
        e.which>=32 ? processKey(e.which) : processKey(e.keyCode);
        
        printBuffer();
        _time++;

});

</script>
</body>

</html>
